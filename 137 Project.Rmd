---
title: "STA 137 Final Project"
author: "Quynh Trinh,"
date: "2025-06-04"
output:
  pdf_document: default
  html_document: default
---

```{r, include=FALSE}
# Load library
library(car)
library(ggplot2)
library(astsa)
library(forecast)
library(MASS)
library(tseries)


# Load data
load("finalproject.Rdata")
```

# Data cleaning

```{r}
finalPro_data <- na.omit(finalPro_data)
```


# GDP Time Series

## Plot GDP Time Series & Observing

```{r}
# Plot GDP
gdp_ts <- ts(finalPro_data$GDP, start = 1960, frequency = 1)

ts.plot(gdp_ts, main="GDP Time Series", ylab="GDP")
```
Summary:

- GDP time series has upward trend, this shows this is non-stationary
- It has peaks around every 10 year: 1980, 1990, 2010

## Diagnostic GDP 

### Coefficients 

```{r}
# 
model_gdp <- lm(GDP ~ Year + Growth + CPI + Imports + Exports + Population, data = finalPro_data)

summary(model_gdp)
```
(Note: default p-value = 0.1)

Significant: Year, CPI, Exports

### Residuals

```{r}
# Residuals diagnostics for GDP
acf(gdp_ts, main = "ACF of GDP Time Series")

#Ljung test
Box.test(gdp_ts)
```

ACF:

- ACF values are decreasing gradually and stay above significance bounds, this means the time series is non-stationary, it likely has trend
  
Ljung-test

- p-value is very small, this means the residuals are not independent.


### Normality and Constant Variance

```{r}
resid_gdp <- residuals(model_gdp)

# Check normality
qqnorm(model_gdp$residuals)
qqline(model_gdp$residuals)

shapiro.test(resid_gdp) # Shapiro-Wilk test

# Check constant variance
plot(fitted(model_gdp), resid_gdp,
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red") # Residuals vs Fitted plot

group <- ifelse(fitted(model_gdp) > median(fitted(model_gdp)), "High", "Low")
leveneTest(resid_gdp ~ group, center=median)
```
Normality:

- The residuals are close to the line, this means the data seems to meet normality

- Shapiro: p-value = 0.5794. This means the data met normality

Constant Variance:

- Plot shows no patterns, this means the data seems to meet constant variance

- Brown-Forsythe test: p-value = 0.01507 < 0.05. This means the data not met constant variance. Thus, transformation is needed.

## Box-Cox Transformation for GDP

```{r, include=FALSE}
# Use boxcox for GDP model
bc <- boxcox(model_gdp, lambda = seq(-2, 2, by = 0.1))

# Find best lambda
lambda_gdp <- bc$x[which.max(bc$y)]

```

### Diagnostic for Tranformation


```{r, echo=FALSE}
# Refit using the Box-Cox transformed GDP
# Formula: y(lambda) = (y^lambda - 1)/ lambda
if(lambda_gdp == 0){
  finalPro_data$GDP_boxcox <- log(finalPro_data$GDP)
} else {
  finalPro_data$GDP_boxcox <- (finalPro_data$GDP^lambda_gdp - 1)/lambda_gdp
}
model_gdp_boxcox <- lm(GDP_boxcox ~ Year + Growth + CPI + Imports + Exports + Population, data = finalPro_data)

# Coefficients
summary(model_gdp_boxcox)
```

Significant coefficients: Year, CPI, Exports, Population

```{r}
# Normality box-cox
resid_gdp_boxcox <- residuals(model_gdp_boxcox)

# Check normality
qqnorm(model_gdp_boxcox$residuals)
qqline(model_gdp_boxcox$residuals)

shapiro.test(resid_gdp_boxcox) # Shapiro-Wilk test

# Check constant variance
plot(fitted(model_gdp_boxcox), resid_gdp_boxcox,
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted after Transforming")
abline(h = 0, col = "red") # Residuals vs Fitted plot

group_gdp_boxcox <- ifelse(fitted(model_gdp_boxcox) > median(fitted(model_gdp_boxcox)), "High", "Low")
leveneTest(resid_gdp_boxcox ~ group_gdp_boxcox, center=median)

```
Normality and Constant Variance:

- Both assumptions are met after transforming

## Find the best ARIMA model for GDP Using auto.arima()

```{r}
arima_gdp <- auto.arima(gdp_ts)
arima_gdp
```
Suggested: ARIMA(0,1,0)


# Imports Time Series

## Plot Imports Time Series

```{r}
# Plot imports
imports_ts <- ts(finalPro_data$Imports, start = 1960, frequency = 1)

ts.plot(imports_ts, main="Imports Time Series", ylab="Imports")
```

Summary:

- The plot shows there is downward trend from 1960 to 2005, and increasing after that

- This means the Imports time series is non-stationary

## Diagnostics Imports

### Coefficients

```{r}
model_imports <- lm(Imports ~ Year + Growth + CPI + GDP + Exports + Population, data = finalPro_data)

summary(model_imports)
```
Significant: CPI, Exports

### Residuals

```{r}
# Residuals diagnostics for Imports
acf(imports_ts, main = "ACF of Imports Time Series")

#Ljung test
Box.test(imports_ts)
```

ACF:

- ACF values decrease gradually and stay above significance bounds, this means the time series is non-stationary

Ljung test:

- p-value = 7.46e-11, this means the residuals are not independent


### Normality and Constant Variance

```{r}
resid_imports <- residuals(model_imports)

# Check normality
qqnorm(model_imports$residuals)
qqline(model_imports$residuals)

shapiro.test(resid_imports) # Shapiro-Wilk test

# Check constant variance
plot(fitted(model_imports), resid_imports,
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red") # Residuals vs Fitted plot

group_imports <- ifelse(fitted(model_imports) > median(fitted(model_imports)), "High", "Low")
leveneTest(resid_imports ~ group_imports, center=median)
```

Normality:

- Most residuals are close to the line except some points at the right end of the plot. The data might meet normality

- Shapiro test: p-value = 0.1748. This means the data met normality

Constant Variance:

- The plot shows some patterns; most points are at the left side and waving pattern. This means the data might not meet constant variance

- Brown test: 0.07019 > 0.05. This means the data met constant variance

Thus, there is no needed for transforming Imports model.

## Find the Best ARIMA Model for Imports Using auto.arima()

```{r}
arima_imports <- auto.arima(imports_ts)
arima_imports
```

Suggested: ARIMA(0,1,2)

# Save cleaned transformation

```{r}
# Remove GDP, Country, Code
finalPro_data$GDP <- NULL
finalPro_data$Country <- NULL
finalPro_data$Code <- NULL

# Save the updated data frame to CSV
write.csv(finalPro_data, file = "finalPro_data_BoxCox.csv", row.names = FALSE)
```
```{r}
# Central African Republic GDP ARIMA Model
# Author: Om C

# STEP 1: Use Pre-transformed Data (from EDA)
gdp_ts <- ts(finalPro_data_transformed$GDP_boxcox, start = 1960, frequency = 1)

# STEP 2: Plot and Model Identification
par(mfrow = c(2,2))
plot(gdp_ts, main = "Box-Cox Transformed GDP (from EDA)", ylab = "Transformed GDP", type = "l", lwd = 2)
plot(diff(gdp_ts), main = "First Difference", ylab = "Change in GDP", type = "l", lwd = 2)
abline(h = 0, col = "red", lty = 2)
# ACF/PACF of differenced series
acf(diff(gdp_ts), main = "ACF: Differenced GDP", lag.max = 20)
pacf(diff(gdp_ts), main = "PACF: Differenced GDP", lag.max = 20)
par(mfrow = c(1,1))
cat("ACF/PACF Analysis: No significant lags detected so ARIMA(0,1,0)\n\n")

# STEP 3: Model Comparison
models <- list(
  "ARIMA(0,1,0)" = c(0,1,0),
  "ARIMA(1,1,0)" = c(1,1,0),
  "ARIMA(0,1,1)" = c(0,1,1),
  "ARIMA(1,1,1)" = c(1,1,1)
)
results <- data.frame(Model=character(), AIC=numeric(), BIC=numeric(), 
                     Ljung_Box_p=numeric(), stringsAsFactors=FALSE)

for(i in 1:length(models)) {
  fit <- Arima(gdp_ts, order = models[[i]], method = "ML")
  ljung_p <- Box.test(residuals(fit), lag = 10, type = "Ljung-Box")$p.value
  results <- rbind(results, data.frame(
    Model = names(models)[i],
    AIC = fit$aic,
    BIC = BIC(fit),
    Ljung_Box_p = ljung_p
  ))
}
print(results)
cat("\nBest model by AIC:", results$Model[which.min(results$AIC)], "\n")

# STEP 4: Final Model and Diagnostics
final_model <- Arima(gdp_ts, order = c(0,1,0), method = "ML")
print(final_model)
residuals_final <- residuals(final_model)
cat("\nDiagnostic Tests:\n")
# 1. Ljung-Box test
ljung <- Box.test(residuals_final, lag = 10, type = "Ljung-Box")
cat("Ljung-Box test p-value:", round(ljung$p.value, 4), 
    ifelse(ljung$p.value > 0.05, "(PASS)", "(FAIL)"), "\n")
# 2. Normality test
shapiro <- shapiro.test(residuals_final)
cat("Shapiro-Wilk test p-value:", round(shapiro$p.value, 4), 
    ifelse(shapiro$p.value > 0.05, "(PASS)", "(Borderline)"), "\n")
# 3. ARCH test
arch <- Box.test(residuals_final^2, lag = 5, type = "Ljung-Box")
cat("ARCH test p-value:", round(arch$p.value, 4), 
    ifelse(arch$p.value > 0.05, "(PASS)", "(FAIL)"), "\n")
cat("\nSlight non-normality detected but acceptable for ARIMA modeling\n")
cat("Q-Q plot shows approximate normality with minor tail deviations\n\n")

# STEP 5: Forecast with Inverse Transformation
forecast_result <- forecast(final_model, h = 3)
lambda <- 0.1
# Inverse Box-Cox transformation
forecast_original <- (lambda * forecast_result$mean + 1)^(1/lambda)
lower_original <- (lambda * forecast_result$lower + 1)^(1/lambda)
upper_original <- (lambda * forecast_result$upper + 1)^(1/lambda)
cat("1-step ahead forecast (original GDP scale):", round(forecast_original[1], 2), "million USD\n")
cat("95% prediction interval: [", round(lower_original[1,2], 2), ",", 
    round(upper_original[1,2], 2), "] million USD\n\n")
cat("FINAL MODEL: ARIMA(0,1,0) for Box-Cox transformed GDP\n")
```



