---
title: "STA 137 Final Project"
author: "Quynh Trinh,"
date: "2025-06-04"
output:
  pdf_document: default
  html_document: default
---

```{r, include=FALSE}
# Load library
library(car)
library(ggplot2)
library(astsa)
library(forecast)
library(MASS)
library(dplyr)


# Load data
load("finalproject.Rdata")
```

# Data Cleaning

Keep Year, Imports, and GDP columns

```{r}
finalPro_data <- finalPro_data[, c("Year", "Imports", "GDP")]
```


# I. GDP Time Series

## Plot GDP Time Series

```{r}
# Plot GDP
gdp_ts <- ts(finalPro_data$GDP, start = 1960, frequency = 2)

ts.plot(gdp_ts, main="GDP Time Series", ylab="GDP")
```
Summary:

- GDP time series has upward trend, this shows this is non-stationary
- It has peaks around every 10 year: 1980, 1990, 2010

## Differencing GDP

```{r}
# 1st order difference
diff_gdp <- diff(gdp_ts)

ts.plot(diff_gdp, main="First Order Difference GDP Time Series", ylab="GDP")

acf(diff_gdp)
pacf(diff_gdp)

```

## Box-Cox Transformation

```{r}
# If there are negative/zero values, shift the series:
min_val <- min(diff_gdp, na.rm = TRUE)
if (min_val <= 0) {
  gdp_diff_bc <- diff_gdp + abs(min_val) + 1
} else {
  gdp_diff_bc <- diff_gdp
}

# Find the best lambda for Box-Cox
bc <- boxcox(gdp_diff_bc ~ 1, lambda = seq(-2, 2, by = 0.1))
lambda <- bc$x[which.max(bc$y)]

# Apply the transformation
if (lambda == 0) {
  gdp_diff_trans <- log(gdp_diff_bc)
} else {
  gdp_diff_trans <- (gdp_diff_bc^lambda - 1) / lambda
}

shapiro.test(gdp_diff_trans)
```
- new shapiro-wilk p-value is very small after differencing


## Diagnostic GDP 

### Coefficients 

```{r}
# 
model_gdp <- lm(GDP ~ Year, data = finalPro_data)
```
(Note: default p-value = 0.1)

Significant: Year, CPI, Exports

### Residuals

```{r}
# Residuals diagnostics for GDP
acf(gdp_ts, main = "ACF of GDP Time Series")

#Ljung test
#Box.test(gdp_ts)
```

ACF:

ACF values are decreasing gradually and stay above significance bounds, this means the time series is non-stationary, it likely has trend
  


### Check Normality and White Noise

```{r}
resid_gdp <- residuals(model_gdp)

# Check normality
qqnorm(model_gdp$residuals)
qqline(model_gdp$residuals)

shapiro.test(resid_gdp) # Shapiro-Wilk test

# Portmanteau Test (Ljung-Box)
Box.test(resid_gdp, lag = 10, type = "Ljung-Box")
```
Normality:

Based on the QQ-plot for GDP time series, we see that there are most residuals are notclose to the line, which means the model might meet the assumption of normality. Then, we use Shapiro-Wilk test and got a p-value = 0.09966. Since the p-value is bigger than $\alpha = 0.05$, we conclude that our model for GDP is normally distributed.


Next, we use Portmanteau Test (Ljung-Box) to test whether residuals are white noise. The null hypothesis for this test is residuals are white noise. After running the test, we got p-value $< 2.2e-16$. Since p-value $< 0.05$, we conclude that residuals are not white noise. Thus, we will transform our data to make it stationary. 




## Box-Cox Transformation for GDP

```{r, include=FALSE}
# Use boxcox for GDP model
bc <- boxcox(diff_gdp, lambda = seq(-2, 2, by = 0.1))

# Find best lambda
lambda_gdp <- bc$x[which.max(bc$y)]

```

### Diagnostic for Tranformation


```{r, echo=FALSE}
# Refit using the Box-Cox transformed GDP
# Formula: y(lambda) = (y^lambda - 1)/ lambda
if(lambda_gdp == 0){
  finalPro_data$GDP_boxcox <- log(finalPro_data$GDP)
} else {
  finalPro_data$GDP_boxcox <- (finalPro_data$GDP^lambda_gdp - 1)/lambda_gdp
}
model_gdp_boxcox <- lm(GDP_boxcox ~ Year, data = finalPro_data)

# Coefficients
summary(model_gdp_boxcox)
```


```{r}
# Normality box-cox
resid_gdp_boxcox <- residuals(model_gdp_boxcox)

# Check normality
qqnorm(model_gdp_boxcox$residuals)
qqline(model_gdp_boxcox$residuals)

shapiro.test(resid_gdp_boxcox) # Shapiro-Wilk test

```
Normality and Constant Variance:

- Both assumptions are met after transforming

## Find the best ARIMA model for GDP Using auto.arima()

```{r}
arima_gdp <- auto.arima(gdp_ts)
arima_gdp
```
Suggested: ARIMA(0,1,0)


# II. Imports Time Series

## Plot Imports Time Series

```{r}
# Plot imports
imports_ts <- ts(finalPro_data$Imports, start = 1960, frequency = 1)

ts.plot(imports_ts, main="Imports Time Series", ylab="Imports")
```

Summary:

- The plot shows there is downward trend from 1960 to 2005, and increasing after that

- This means the Imports time series is non-stationary

## Diagnostics Imports

### Coefficients

```{r}
model_imports <- lm(Imports ~ Year + Growth + CPI + GDP + Exports + Population, data = finalPro_data)

summary(model_imports)
```
Significant: CPI, Exports

### Residuals

```{r}
# Residuals diagnostics for Imports
acf(imports_ts, main = "ACF of Imports Time Series")

#Ljung test
Box.test(imports_ts)
```

ACF:

- ACF values decrease gradually and stay above significance bounds, this means the time series is non-stationary

Ljung test:

- p-value = 7.46e-11, this means the residuals are not independent


### Normality and Constant Variance

```{r}
resid_imports <- residuals(model_imports)

# Check normality
qqnorm(model_imports$residuals)
qqline(model_imports$residuals)

shapiro.test(resid_imports) # Shapiro-Wilk test

# Check constant variance
plot(fitted(model_imports), resid_imports,
     xlab = "Fitted values", ylab = "Residuals",
     main = "Residuals vs Fitted")
abline(h = 0, col = "red") # Residuals vs Fitted plot

group_imports <- ifelse(fitted(model_imports) > median(fitted(model_imports)), "High", "Low")
leveneTest(resid_imports ~ group_imports, center=median)
```

Normality:

- Most residuals are close to the line except some points at the right end of the plot. The data might meet normality

- Shapiro test: p-value = 0.1748. This means the data met normality

Constant Variance:

- The plot shows some patterns; most points are at the left side and waving pattern. This means the data might not meet constant variance

- Brown test: 0.07019 > 0.05. This means the data met constant variance

Thus, there is no needed for transforming Imports model.

## Find the Best ARIMA Model for Imports Using auto.arima()

```{r}
arima_imports <- auto.arima(imports_ts)
arima_imports
```

Suggested: ARIMA(0,1,0)

# Save cleaned transformation

```{r}
# Remove GDP, Country, Code
finalPro_data$GDP <- NULL
finalPro_data$Country <- NULL
finalPro_data$Code <- NULL

# Save the updated data frame to CSV
write.csv(finalPro_data, file = "finalPro_data_BoxCox.csv", row.names = FALSE)
```

