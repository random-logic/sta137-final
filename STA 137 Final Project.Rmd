---
title: "STA 137 Final Project"
author: "Quynh Trinh,"
date: "2025-06-04"
output:
  pdf_document: default
  html_document: default
---

```{r, include=FALSE}
# Load library
library(car)
library(ggplot2)
library(astsa)
library(forecast)
library(MASS)
library(dplyr)


# Load data
load("finalproject.Rdata")
```

# Data Cleaning

Since we focus on GDP and Imports, we will keep Year, Imports, and GDP and drop other columns.

```{r}
finalPro_data <- finalPro_data[, c("Year", "Imports", "GDP")]
```


# I. GDP Time Series

## Plot GDP Time Series

We will plot the GDP time series to see whether the our data is consistent over time. 

```{r}
# Plot GDP
gdp_ts <- ts(finalPro_data$GDP, start = 1960, frequency = 2)

ts.plot(gdp_ts, main="GDP Time Series", ylab="GDP")
```

Based on the GDP time series, we see that the plot has upward trend and some peaks, showing economic growth over the period. This suggests that the data is not consistent. To have further analysis, we would transform and detrend the data to analyze fluctuation more clearly.

## Transform (log)

```{r}
# Log transform GDP
log_gdp_ts <- log(gdp_ts)
ts.plot(log_gdp_ts, main="Log GDP Time Series", ylab="GDP")
```

## Detrend GDP

```{r}
# Detrend log-transformed GDP using linear regression
time_index <- 1:length(log_gdp_ts)
trend_model <- lm(log_gdp_ts ~ time_index)
detrended_log_gdp <- residuals(trend_model)

# Plot detrended log-GDP
ts.plot(detrended_log_gdp, main = "Detrended Log GDP Time Series", ylab = "Detrended Log-GDP")
```

Didn't work, use differencing.

## Transform (Box-Cox)

Since the Imports time series is not consistent, we will use Box-Cox transformation to stabilize the data, which make it easier to work with by reducing big spikes.

```{r}
# Box-Cox transform GDP
lambda <- BoxCox.lambda(gdp_ts)
boxcox_gdp_ts <- BoxCox(gdp_ts, lambda)
ts.plot(boxcox_gdp_ts, main = paste("Box-Cox Transformed GDP (lambda =", round(lambda, 3), ")"), ylab = "Transformed GDP")
```

Compared to the original GDP time series, the Box-Cox transformed series has stabilized the variance and made the trend more linear; we see don't see big spikes though there is still upward trend. Thus, the transformation works well and useful for further statistical analysis and modeling.

## Differencing GDP

Since our data is still non-stationary, we would take the first difference to make it into a more stationary.

```{r}
diff_gdp_bc <- diff(boxcox_gdp_ts)

# Plot differenced Box-Cox GDP
ts.plot(diff_gdp_bc, main="Differenced Box-Cox Transformed GDP Time Series", ylab="Transformed GDP")
```

After the first differencing, we see that the data appears more stationary, with changes fluctuating around a constant mean. However, there are still some periods with unusually large increases or decreases, suggesting the presence of significant economic events.

```{r}
# Fit a basic linear model for demonstration
model_gdp_bc <- lm(diff_gdp_bc ~ time(diff_gdp_bc))
resid_gdp_bc <- residuals(model_gdp_bc)

# Plot ACF and PACF of residuals
par(mfrow = c(1, 2))  # Side-by-side plots
acf(resid_gdp_bc, main = "ACF of Residuals")
pacf(resid_gdp_bc, main = "PACF of Residuals")
par(mfrow = c(1, 1))  # Reset layout

# Portmanteau (Box-Pierce) test for white noise
portmanteau_result <- Box.test(resid_gdp_bc, lag = 10, type = "Box-Pierce")
print(portmanteau_result)

```

To make sure the residuals are white noise, we plot ACF and PACF. The ACF shows that most of the spikes are below the blue line, which means there’s probably no strong pattern left, and the model already captured the main trends in the data. The spikes in the PACF also fall inside the blue line area, which suggests that we’ve captured most of the useful patterns.

We use Portmanteau Test to confirm whether residuals are white noise. The null hypothesis for this test is residuals are white noise. After running the test, we got p-value = 0.8434. Since p-value $> 0.05$, we conclude that residuals are white noise.

## Assess Normality

```{r}
# Assess Normality of Residuals

# Histogram
hist(resid_gdp_bc, breaks = 15, main = "Histogram of Residuals", xlab = "Residuals", col = "lightblue", border = "white")

# Q-Q Plot
qqnorm(resid_gdp_bc, main = "Q-Q Plot of Residuals")
qqline(resid_gdp_bc, col = "red")

# Shapiro-Wilk Test
shapiro_test <- shapiro.test(resid_gdp_bc)
print(shapiro_test)
```

Based on the QQ-plot, we see that there are most residuals are close to the line, which means the model might meet the assumption of normality. Then, we use Shapiro-Wilk test and got a p-value = 0.05331. Since the p-value $> 0.05$, we conclude that our model for GDP is normally distributed.

In conclusion, we would use GDP time series after using Box-Cox transformation and first differencing to do model selection for GDP and have further analyzed based on that.


# II. Imports Time Series

## Plot Imports Time Series

We will plot the Imports time series to see whether the our data is consistent over time. 

```{r}
# Plot imports
imports_ts <- ts(finalPro_data$Imports, start = 1960, frequency = 1)

ts.plot(imports_ts, main="Imports Time Series", ylab="Imports")
```

Based on the Imports time series, we see that the plot has downward trend. Until around 2005, the trend goes upward. This suggests that the data is not consistent and there is no regular pattern . To have further analysis, we would transform and detrend the data to analyze the series more clearly.


## Transform (log)

```{r}
# Log transform Imports
log_imports_ts <- log(imports_ts)
ts.plot(log_imports_ts, main="Log Imports Time Series", ylab="Imports")
```

## Detrend Imports

```{r}
# Detrend log-transformed Imports using linear regression
time_index_imports <- 1:length(log_imports_ts)
trend_model_imports <- lm(log_imports_ts ~ time_index_imports)
detrended_log_imports <- residuals(trend_model_imports)

# Plot detrended log-Imports
ts.plot(detrended_log_imports, main = "Detrended Log Imports Time Series", ylab = "Detrended Log-Imports")
```

Didn't work, use differencing

## Box-Cox Transform for Imports

Since the Imports time series is not consistent, we will use Box-Cox transformation to stabilize the data.

```{r}
# Box-Cox transform Imports
lambda_imports <- BoxCox.lambda(imports_ts)
boxcox_imports_ts <- BoxCox(imports_ts, lambda_imports)
ts.plot(boxcox_imports_ts, main = paste("Box-Cox Transformed Imports (lambda =", round(lambda_imports, 3), ")"), ylab = "Transformed Imports")
```



## Differencing Imports

Since our data is non-stationary, we would take the first difference to make it into a more stationary.

```{r}
diff_imports_bc <- diff(boxcox_imports_ts)

# Plot differenced Box-Cox Imports
ts.plot(diff_imports_bc, main="Differenced Box-Cox Transformed Imports Time Series", ylab="Transformed Imports")
```

```{r}
# Fit a basic linear model for demonstration
model_imports_bc <- lm(diff_imports_bc ~ time(diff_imports_bc))
resid_imports_bc <- residuals(model_imports_bc)

# Plot ACF and PACF of residuals
par(mfrow = c(1, 2))  # Side-by-side plots
acf(resid_imports_bc, main = "ACF of Residuals")
pacf(resid_imports_bc, main = "PACF of Residuals")
par(mfrow = c(1, 1))  # Reset layout


# Portmanteau (Box-Pierce) test for white noise
portmanteau_result_imports <- Box.test(resid_imports_bc, lag = 10, type = "Box-Pierce")
print(portmanteau_result_imports)

```
(Interpret later)


## Assess Normality
```{r}
# Assess Normality of Residuals

# Histogram
hist(resid_imports_bc, breaks = 15, main = "Histogram of Residuals", xlab = "Residuals", col = "lightblue", border = "white")

# Q-Q Plot
qqnorm(resid_imports_bc, main = "Q-Q Plot of Residuals")
qqline(resid_imports_bc, col = "red")

# Shapiro-Wilk Test
shapiro_test_imports <- shapiro.test(resid_imports_bc)
print(shapiro_test_imports)
```
The data met normality assumption


# Update csv. file that contains 3 columns

```{r}
write.csv(finalPro_data, file = "finalPro_data_update.csv", row.names = FALSE)
```

